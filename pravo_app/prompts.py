"""
Промпты для LLM в юридическом агенте.

LangChain PromptTemplate с подстановкой query, dialog, docs, response.
Каждый промпт обслуживает конкретный узел графа (уточнение, классификация, RAG и т.д.).
"""
from langchain_core.prompts import PromptTemplate

# Проверяет, хватает ли данных в вопросе для поиска. Если данных мало, он формулирует уточняющий вопрос, иначе отвечает "ок".
#
# Тип: диагностический (выявление недостатка контекста).
# Техника: бинарная классификация с примерами (few-shot) и строгим ограничением на формат ответа.
# Шаблон: подставляет {query} в конец и запрещает продолжать диалог, оставляя только "ок" или вопрос.
clarification_prompt = PromptTemplate.from_template(
    """Ты юридический ассистент в Российской Федерации. Тебе дан вопрос пользователя.
Твоя задача определить, надо ли что-то уточнить у пользователя, чтобы выполнить юридический поиск или вопрос пользователя содержит всю необходимую информацию?
Если вопрос содержит всю необходимую информацию ответь: "ок" и больше ничего не пиши.  
Пример: 
Вопрос пользователя: "мне не заплатили по договору, в какой суд подать иск?"
Ответ: Уточите пожалуйста, вы являетесь физическим лицом, индивидуальным предпринимателем или описываете ситуацию компании (юридического лица)?
Вопрос пользователя: "Какой вычет НДФЛ на первого ребенка"
Ответ: ок
[Вопрос пользователя]: "{query}"
Не отвечай на вопрос пользователя, не продолжай диалог, выполни свою задачу."""
)

# Используется в пакетном режиме: отвечает по существу без уточняющих вопросов.
clarification_prompt_batch = PromptTemplate.from_template(
    """Ты юридический ассистент. Тебе дан вопрос пользователя.
Твоя задача — дать ответ по существу, даже если данных недостаточно.
Не задавай уточняющих вопросов. Не проси дополнительную информацию.
Если информации мало, явно укажи допущения и ответь на основе них.

Формат:
1) Допущения (если нужны)
2) Ответ

[Вопрос пользователя]: "{query}"
Ответ:"""
)

# Сводит диалог в единый поисковый вопрос. Он учитывает все реплики пользователя и выдаёт итоговую формулировку.
#
# Тип: конденсация контекста (суммаризация/переформулирование).
# Техника: инструктивное перефразирование с запретом на лишний текст.
# Шаблон: подставляет {dialog} в блок <dialog> и требует вывести только один итоговый вопрос.
query_concat_prompt = PromptTemplate.from_template(
    """Ты юридический ассистент. Тебе дан диалог с пользователем, твоя задача собрать этот диалог в один вопрос к справочной правовой системе, который учтет всю информацию, полученную от пользователя.
<dialog>
{dialog}
</dialog>
Не продолжай диалог, только сформулируй один вопрос.
Вопрос к поисковой системе:"""
)

# Превращает пользовательский запрос в короткую юридическую поисковую фразу. Он убирает разговорные слова и сохраняет смысл.
#
# Тип: переписывание запроса (query rewriting).
# Техника: rule-based инструкции + few-shot примеры с форматным ограничением "одна строка".
# Шаблон: вставляет {query} и ожидает только итоговую поисковую фразу без пояснений.
query_rewrite_prompt = PromptTemplate.from_template(
    """Ты юридический ассистент. Преобразуй запрос пользователя в краткую, точную поисковую фразу, подходящую для ввода в правовую систему (например, «КонсультантПлюс», «Гарант»).
Требования к результату:
- Сохраняй юридический смысл исходного запроса.
- Используй официальную юридическую терминологию.
- Убирай разговорные формулировки, местоимения и лишние слова.
- Формулируй максимально ёмко — как если бы ты искал в базе законов или судебных решений.
- Не добавляй пояснений, комментариев или примеров.
- Отвечай только одной строкой — самой поисковой фразой.

Примеры преобразований:
Исходный запрос: "Что будет, если не платить алименты?"
Поисковая фраза: Уклонение от уплаты алиментов ответственность
Исходный запрос: "Могу ли я вернуть товар, если он не подошёл по цвету?"
Поисковая фраза: Возврат товара ненадлежащего качества цвет
Исходный запрос: "Какие льготы у ветеранов труда в Москве?"
Поисковая фраза: Льготы ветеранам труда Москва
Исходный запрос: "Судебная практика по увольнению за прогул без объяснений"
Поисковая фраза: Судебная практика увольнение за прогул отсутствие объяснений
Исходный запрос: "Что говорит 217-ФЗ о добровольной ликвидации ООО?"
Поисковая фраза: ФЗ-217 добровольная ликвидация ООО

Теперь обработай следующий запрос (не отвечая на сам вопрос, только сделай перефразировку):
[Исходный запрос]: "{query}"
Поисковая фраза:"""
)

# Классификация запроса к НПА или судебной практике. Он выдаёт ровно одно слово-категорию.

# Тип: классификация (labeling).
# Техника: явное определение классов и строгий формат вывода.
# Шаблон: подставляет {query} и требует ответить только "НПА" или "Судебное".
classification_prompt = PromptTemplate.from_template(
    """Ты юридический ассистент. Проанализируй следующий запрос пользователя и определи, к какой категории он относится:
- "НПА" — если запрос касается нормативно-правовых актов: законов, кодексов, статей, постановлений, правил, положений, требований законодательства, юридических норм, обязанностей по закону и т.п.
- "Судебное" — если запрос касается судебных решений, прецедентов, примеров из практики судов, разборов дел, аргументов в суде, толкования норм судами, позиции ВС/Арбитражных судов и т.п.
Важно: отвечай **только одним словом** — либо "НПА", либо "Судебное".
Запрос: "{query}"
Ответ (одно слово):"""
)

# Формирует структурированный ответ по документам.
# Он включает разделы про законодательство, практику и итоговый вывод.
#
# Тип: RAG-ответ (ответ с опорой на источники).
# Техника: структурный шаблон + запрет внешних знаний.
# Шаблон: вставляет {query} и {docs}, затем требует ответ в фиксированной структуре.
rag_prompt = PromptTemplate.from_template(
    """Ты — опытный юрист. На основе представленных документов ответь на вопрос пользователя, строго придерживаясь следующей структуры:
1. **Законодательство**
   Перечисли применимые нормативно-правовые акты, статьи, положения. Укажи, что именно они устанавливают по вопросу. 
   Ссылайся только на документы, приведённые ниже. Не добавляй внешние знания.
2. **Судебная практика**
   Приведи примеры из судебных решений, если они есть в документах. Укажи: какой суд, по какому делу, какую позицию занял. 
   Если практики нет — напиши: "В представленных документах отсутствует судебная практика по данному вопросу."
3. **Вывод**  
   Дай краткий, однозначный ответ на вопрос, основанный на совокупности НПА и судебной практики. 
   Формулируй как юридическую позицию: что допускается, запрещено, рекомендовано, возможно в суде и т.п.
Требования:
- Отвечай только на основе документов.
- Не вымышляй нормы или дела.
- Используй официальную юридическую терминологию.
- Будь точен, лаконичен, структурирован.
[Вопрос]: "{query}"
[Документы]:
{docs}
Ответ:"""
)

# Формирует структурированный ответ по документам.
# Он включает разделы про законодательство, практику и итоговый вывод. Практика не оценивается только ссылки.
#
# Тип: RAG-ответ (ответ с опорой на источники).
# Техника: структурный шаблон + запрет внешних знаний.
# Шаблон: вставляет {query} и {docs}, затем требует ответ в фиксированной структуре.

rag_prompt_only_link = PromptTemplate.from_template(
    """Ты — опытный юрист. На основе представленных документов ответь на вопрос пользователя, строго придерживаясь следующей структуры:
1. **Законодательство**
   Перечисли применимые нормативно-правовые акты, статьи, положения. Укажи, что именно они устанавливают по вопросу. 
   Ссылайся только на документы, приведённые ниже. Не добавляй внешние знания.
2. **Судебная практика**
   Приведи описание дела в суде. Ссылки на исходные документы. Выведи не более 3 дел.
3. **Вывод**  
   Дай краткий, однозначный ответ на вопрос, основанный на совокупности НПА и судебной практики. 
   Формулируй как юридическую позицию: что допускается, запрещено, рекомендовано, возможно в суде и т.п.
Требования:
- Отвечай только на основе документов.
- Не вымышляй нормы или дела.
- Используй официальную юридическую терминологию.
- Будь точен, лаконичен, структурирован.
[Вопрос]: "{query}"
[Документы]:
{docs}
Ответ:"""
)

# Проверяет полноту чернового ответа и решает, нужен ли доп. поиск.
# Если есть пробелы — формирует новый поисковый запрос.
#
# Тип: рефлексия/самопроверка.
# Техника: контроль качества с бинарным исходом ("ок" или новая поисковая фраза) и примерами.
# Шаблон: подставляет {query} и {response}, затем требует вернуть только "ок" или запрос.
reflection_prompt = PromptTemplate.from_template(
    """Ты — эксперт-юрист. Проанализируй вопрос пользователя и черновик ответа. 
Оцени, насколько черновик ответа полностью раскрывает вопрос с точки зрения:
- нормативно-правового регулирования (НПА),
- судебной практики (если уместно),
- возможных нюансов, условий, исключений.
Если ответ:
- полностью раскрывает вопрос по всем значимым аспектам → верни одну фразу: "ок" и больше ничего не пиши.
- недостаточен, содержит пробелы или требует уточнения → сформулируй один точный поисковой запрос для справочно-правовой системы (например, «КонсультантПлюс», «Гарант»), который поможет дополнить ответ. Запрос должен быть кратким, ёмким, с использованием юридической терминологии.
Не добавляй пояснений. Отвечай только "ок" или поисковой фразой.
---
Пример 1:
Вопрос: Можно ли уволить сотрудника за однократный прогул без предупреждений?
Черновик ответа: Да, можно. Согласно ст. 81 ТК РФ, прогул является основанием для увольнения.
Твой ответ: Судебная практика увольнение за прогул отсутствие уведомления
Пример 2:
Вопрос: Облагается ли НДС продажа доли в уставном капитале ООО?
Черновик ответа: Нет, передача доли в уставном капитале ООО не облагается НДС на основании п. 2 ст. 149 НК РФ.
Твой ответ: ок
---
[Вопрос]: "{query}"
[Черновик ответа]: {response}
[Твой ответ]:"""
)

# Собирает финальный развернутый ответ по документам.
# Он использует ту же структуру, но допускает более подробный вывод.
#
# Тип: финальный RAG-ответ (синтез).
# Техника: фиксированная структура + запрет на внешние знания.
# Шаблон: подставляет {query} и {docs} и просит выдать полный ответ по шаблону.

final_answer_prompt = PromptTemplate.from_template(
    """Ты — опытный юрист. На основе представленных документов ответь на вопрос пользователя, строго придерживаясь следующей структуры:
1. **Законодательство**
   Перечисли применимые нормативно-правовые акты, статьи, положения. Укажи, что именно они устанавливают по вопросу. Ссылайся только на документы, приведённые ниже. Не добавляй внешние знания.
2. **Судебная практика**
   Приведи примеры из судебных решений, если они есть в документах. Укажи: какой суд, по какому делу, какую позицию занял. Если практики нет — напиши: "В представленных документах отсутствует судебная практика по данному вопросу."
3. **Вывод**  
    Дай развернутый ответ на основе всех предложенных документов. Формулируй как юридическую позицию: что допускается, запрещено, рекомендовано, возможно в суде и т.п.

Требования:
- Отвечай только на основе документов.
- Не вымышляй нормы или дела.
- Используй официальную юридическую терминологию.
- Будь точен, лаконичен, структурирован.
[Вопрос]: "{query}"
[Документы]:
{docs}
Ответ:"""
)
