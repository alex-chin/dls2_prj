# LLM-агент юридического ассистента

Прототип юридического LLM-ассистента, отвечающего на правовые вопросы с
использованием **Recursive Retrieval-Augmented Generation (Recursive RAG)** и
графа состояний LangGraph.

---

## Основания разработки системы

Система разработана в рамках выпускной квалификационной работы (Школа глубокого
обучения ФПМИ МФТИ). Задача — реализовать агента, способного:

- определять правовую природу запроса пользователя;
- выявлять необходимость обращения к внешним правовым источникам;
- формировать поисковые запросы к нормативно-правовой информации;
- итеративно уточнять поиск с учётом полученных данных;
- агрегировать и структурировать правовую позицию;
- формировать итоговый ответ с указанием источников и оговоркой о
  непредоставлении юридической консультации.

**Архитектура:**

1. **LLM как управляющий агент** — принимает решения: достаточно ли знаний
   модели, нужен ли внешний поиск, требуется ли уточнение или повторный поиск.
2. **Поиск во внешних источниках** — тексты законов, разъяснения регуляторов,
   судебная практика (на этапе прототипа — веб-поиск с возможностью замены на
   Garant API).
3. **Рекурсивный RAG** — несколько циклов поиска, уточнение правового контекста,
   проверка актуальности норм.
4. **Граф состояний LangGraph** — контролируемость решений, воспроизводимость,
   расширяемость.

## Общая схема работы

![legal graph.png](legal%20graph.png)

---

## Методика оценки качества

Качество ответов оценивается по 8 критериям как **качество правового решения**,
а не только текста:

| № | Критерий                        | Обозначение | Описание                                                                  |
|---|---------------------------------|-------------|---------------------------------------------------------------------------|
| 1 | Юридическая корректность        | LCS         | Соответствие действующему законодательству и правоприменительной практике |
| 2 | Обоснованность по источникам    | SGS         | Наличие и идентифицируемость источников права                             |
| 3 | Актуальность правовых норм      | NVS         | Соответствие действующей редакции                                         |
| 4 | Полнота правового анализа       | LCV         | Охват юридически значимых аспектов запроса                                |
| 5 | Структурная корректность        | SCS         | Логичность, структурированность, аргументированность                      |
| 6 | Контекстуальная релевантность   | CRS         | Соответствие запросу без избыточной генерализации                         |
| 7 | Устойчивость к галлюцинациям    | HRS         | Отсутствие вымышленных норм и решений                                     |
| 8 | Процедурная корректность агента | ARQ         | Корректность retrieval, рекурсии, остановки                               |

**Интегральная оценка:** Q = Σ wᵢ · Sᵢ, где Sᵢ — нормализованное значение
критерия, wᵢ — вес (LCS и HRS имеют максимальный вес). Методы оценки: экспертная
разметка, трассировка LangGraph, LLM-as-a-Judge.

Подробнее: [
`Методика анализа качества по критериям.md`](Методика%20анализа%20качества%20по%20критериям.md), [
`Юридический агент Постановка задачи.md`](Юридический%20агент%20Постановка%20задачи.md).

---

## Структура проекта

```
dls2_prj/
├── main.py              # Точка входа: запуск агента (CLI)
├── legal_request.py     # Импорт данных, пакетный прогон, формирование итогового документа
├── langgraph.json       # Конфигурация LangGraph Studio
├── pravo_app/           # Модуль юридического агента (LangGraph, узлы, поиск)
├── Expert Quality Assessment/ # Материалы и скрипты оценки качества ответов
├── legal requests/      # Входные данные: JSON-запросы, методика генерации
├── batch_08022026/      # Результаты пакетной обработки (JSON)
├── docs/                # Документация: Garant API, судебная практика
├── exam01/              # Демо Recursive RAG на LangGraph (Jupyter)
├── orig_yandex/         # Исходный курс по агентам LLM
└── prototype/           # Монолитный прототип PravoMentor
```

---

## Содержимое директорий

| Директория          | Содержимое                                                                                                                                                                         |
|---------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **pravo_app/**      | Модульный юридический агент: граф LangGraph, узлы (уточнение, классификация, поиск НПА/судебки, RAG, самопроверка), провайдеры поиска (DuckDuckGo, Garant), промпты, конфигурация. |
| **Expert Quality Assessment/** | Оценка качества ответов: таблица экспертной оценки, веса и правила трансформации, скрипт `import_metrics.py`, результаты в CSV.                                                   |
| **legal requests/** | Входные данные: `legal_requests.json` (запросы с категориями), `Генерация запросов к агенту.md`, готовый `legal_process.md` и `legal_process.docx`.                                |
| **batch_08022026/** | Результаты пакетной обработки от 08.02.2026: JSON с ответами агента (запрос, категория, ответ, сгенерированные вопросы).                                                           |
| **docs/**           | Справочная документация: Garant API, ресурсы по судебной практике, `test_garant.py`.                                                                                               |
| **exam01/**         | Демо-реализация Recursive RAG на LangGraph в Jupyter — исходная и доработанная версии.                                                                                             |
| **orig_yandex/**    | Материалы курса по агентам LLM: ноутбук `llm_agents_init.ipynb`.                                                                                                                   |
| **prototype/**      | Ранний прототип `PravoMentor.py` — монолитная версия до модульной `pravo_app`.                                                                                                     |

---

## Основные библиотеки

| Библиотека            | Назначение                                             |
|-----------------------|--------------------------------------------------------|
| **langgraph**         | Граф состояний агента (узлы, рёбра, условные переходы) |
| **langchain-core**    | PromptTemplate для промптов                            |
| **gigachat**          | LLM GigaChat (классификация, переформулировка, RAG)    |
| **ddgs**              | Поиск через DuckDuckGo                                 |
| **trafilatura**       | Извлечение текста веб-страниц                          |
| **requests**          | HTTP-запросы к Garant API                              |
| **python-dotenv**     | Переменные окружения (`.env`)                          |
| **typing_extensions** | TypedDict для состояния графа                          |

---

## Основные операции

### 1. Импорт данных

Импорт запросов из Markdown в JSON:

```bash
python legal_request.py
# В __main__ задать ACTION = "import_md"
# MD_INPUT_PATH = "legal requests/Генерация запросов к агенту.md"
# JSON_INPUT_PATH = "legal requests/legal_requests.json"
```

Или программно:

```python
from legal_request import load_requests_from_md, save_requests_json

load_requests_from_md("legal requests/Генерация запросов к агенту.md")
save_requests_json("legal requests/legal_requests.json")
```

### 2. Работа в LangGraph Studio

Визуализация и отладка графа:

```bash
pip install -U "langgraph-cli[inmem]"
langgraph dev
```

Конфигурация в `langgraph.json`: граф `pravo_app.graph:graph`, зависимости из
текущей директории, `.env` для переменных окружения.

### 3. Пакетный прогон

Обработка запросов через агента с сохранением в JSON:

```bash
python legal_request.py
# В __main__ задать ACTION = "batch"
# JSON_INPUT_PATH = "legal requests/legal_requests.json"
# BATCH_LIMIT, START_INDEX — срез запросов
```

Или программно:

```python
from legal_request import process_requests_batch, load_requests_json

load_requests_json("legal requests/legal_requests.json")
results = process_requests_batch(
    input_path="legal requests/legal_requests.json",
    output_path="batch_08022026/legal_process.json", limit=10, start_index=1, )
```

### 4. Формирование итогового документа для оценки

Сборка JSON в единый Markdown для экспертной оценки:

```bash
python legal_request.py
# В __main__ задать ACTION = "print"
# По умолчанию — legal_process_*.json → legal_process.md
```

Или программно:

```python
from legal_request import legal_process_print

legal_process_print(mask="batch_08022026/legal_process_*.json",
    output_path="legal requests/legal_process.md", )
```

### 5. Экспертная оценка качества (метрики и Q)

Импорт таблицы, трансформация метрик и расчет среднего качества:

```bash
python "Expert Quality Assessment/import_metrics.py"
# В main() выбрать этапы:
# RUN_IMPORT = True/False
# RUN_TRANSFORM = True/False
# RUN_AVERAGE = True/False
```

### 6. Интерактивный запуск (один запрос)

```bash
python main.py
```

Переменные окружения:

- `PRAVO_QUERY` — запрос (иначе используется демо-запрос)
- `PRAVO_RUN_MODE` — `debug` или `simple`
- `PRAVO_USE_INPUT=1` — `input()` вместо `interrupt()` для уточнений
- `PRAVO_SEARCH_PROVIDER` — `ddgs` (по умолчанию) или `garant`
- `GARANT_API_KEY` — токен Garant API
- `GIGACHAT_API_KEY` — токен GigaChat (обязательно)
