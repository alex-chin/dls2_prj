<h3 style="text-align: center;"><b>Школа глубокого обучения ФПМИ МФТИ</b></h3>
<h2 style="text-align: center;"><b>Выпускная квалификационная работа</b></h2>
<h2 style="text-align: center;"><b>LLM-агент юридического ассистента</b></h2>

## Описание задачи

Разработать **LLM-агента юридического ассистента**, способного отвечать на правовые вопросы,
требующие анализа нормативных актов, разъяснений регуляторов и судебной практики, с использованием
**Recursive Retrieval-Augmented Generation (Recursive RAG)**.

Агент должен самостоятельно:

* определять правовую природу запроса пользователя;
* выявлять необходимость обращения к внешним правовым источникам;
* формировать поисковые запросы к нормативно-правовой информации;
* итеративно уточнять поиск с учётом полученных данных;
* агрегировать и структурировать правовую позицию;
* формировать итоговый ответ с указанием источников и оговоркой о непредоставлении юридической
  консультации.

## Постановка задачи

В рамках выпускной квалификационной работы требуется реализовать прототип юридического
LLM-ассистента, в котором:

1. **LLM выступает в роли управляющего агента**, принимающего решения:

    * достаточно ли собственных знаний модели для ответа;
    * требуется ли обращение к внешним правовым источникам;
    * необходимо ли дополнительное уточнение или повторный поиск.

2. **Поиск правовой информации осуществляется во внешних источниках**, таких как:

    * тексты законов и подзаконных актов;
    * официальные разъяснения государственных органов;
    * публикации судебной практики.

   На этапе прототипирования допускается использование общего веб-поиска, с последующей возможностью
   замены на специализированные правовые базы.

3. **RAG-процесс является рекурсивным**, то есть агент может:

    * выполнять несколько циклов поиска;
    * уточнять правовой контекст (юрисдикция, период действия нормы, уровень акта);
    * проверять актуальность найденных норм.

4. **Логика работы агента формализуется в виде графа состояний** (state machine), реализованного с
   использованием LangGraph, что обеспечивает:

    * контролируемость принятия решений;
    * воспроизводимость поведения;
    * возможность расширения агентной логики.

---

## Допущения и ограничения

Для упрощения реализации вводятся следующие допущения:

* Используется готовая LLM без специализированного дообучения на юридических текстах.
* Источники правовой информации считаются достоверными, без глубокой проверки иерархии норм.
* Агент не несёт юридической ответственности и формирует ответы в информационно-справочном формате.
* Оценка качества ответов проводится экспертно, без формальных автоматических метрик.
* Отсутствует учёт региональных различий внутри одной юрисдикции, если иное не указано в запросе.

Данные ограничения предполагается снять или ослабить в дальнейших исследованиях.

---

## Возможные направления развития

В перспективе работа может быть расширена за счёт:

* интеграции со специализированными правовыми системами (КонсультантПлюс, Гарант, LexisNexis и др.);
* внедрения проверки актуальности норм (дата, редакция, утрата силы);
* добавления агента-верификатора правовой позиции;
* сравнения recursive RAG с классическим юридическим RAG;
* оценки рисков галлюцинаций в правовых ответах;
* анализа применимости подхода для корпоративного legal-tech.

---

## Научная и практическая значимость

Работа демонстрирует применимость **agentic LLM-подходов** и **recursive RAG** для задач
юридического анализа, где:

* невозможно заранее определить релевантные источники;
* требуется многошаговое уточнение правового контекста;
* критична структурированность и обоснованность ответа.

Результаты исследования могут быть использованы при разработке:

* интеллектуальных юридических ассистентов;
* справочно-правовых систем нового поколения;
* корпоративных инструментов правового анализа и комплаенса.

Ниже приведён формализованный раздел **«Критерии оценки качества юридических ответов»**,
предназначенный для включения в структуру ВКР по теме LLM-ассистента с recursive RAG-архитектурой.

---

## Формальные критерии оценки качества юридических ответов

Оценка качества работы юридического LLM-ассистента осуществляется по совокупности **формальных,
структурных, содержательных и процедурных метрик**, позволяющих объективно анализировать
корректность, надёжность и применимость генерируемых ответов.

### 1. Юридическая корректность (Legal Correctness Score, LCS)

**Описание:**
Соответствие содержания ответа действующему законодательству и правоприменительной практике.

**Метод оценки:**

* экспертная разметка (юрист-ассессор);
* бинарная шкала или шкала Лайкерта (0–2 / 0–5):

    * 0 — некорректно;
    * 1 — частично корректно;
    * 2 — корректно.

**Формальный критерий:**

> Ответ не должен содержать противоречащих нормам формулировок и ложных правовых утверждений.

---

### 2. Обоснованность Источников (Source Grounding Score, SGS)

**Описание:**
Наличие ссылок на источники права и объяснимость правовой позиции.

**Метрики:**

* доля ответов с указанием источников (%);
* среднее количество источников на ответ;
* наличие структурированной ссылки:

    * тип акта,
    * название,
    * статья/пункт,
    * дата редакции.

**Формальный критерий:**

> Ответ считается обоснованным, если содержит не менее одного идентифицируемого правового источника.

---

### 3. Актуальность норм (Norm Validity Score, NVS)

**Описание:**
Соответствие указанных норм действующей редакции законодательства.

**Метод оценки:**

* ручная проверка экспертом;
* автоматизированная проверка по датам публикации источников (в перспективе).

**Шкала:**

* 0 — норма утратила силу;
* 1 — редакция устаревшая;
* 2 — актуальная редакция.

---

### 4. Полнота правового анализа (Legal Coverage Score, LCV)

**Описание:**
Степень охвата юридически значимых аспектов запроса.

**Метод оценки:**

* экспертное сравнение с эталонным разбором (gold answer);
* измерение доли покрытых аспектов (%).

**Пример аспектов:**

* юрисдикция;
* уровень нормативного акта;
* исключения;
* условия применения нормы;
* судебная практика.

---

### 5. Структурная корректность ответа (Structural Compliance Score, SCS)

**Описание:**
Соответствие ответа формальной юридической структуре.

**Формальные признаки:**

* логическая сегментация;
* разделение фактов и выводов;
* аргументационная последовательность;
* наличие дисклеймера.

**Метрика:**
Чек-листовая оценка (0/1 по каждому критерию).

---

### 6. Контекстуальная релевантность (Contextual Relevance Score, CRS)

**Описание:**
Соответствие ответа исходному запросу без избыточной генерализации.

**Методы:**

* cosine similarity embedding-представлений (векторная метрика);
* LLM-as-a-Judge;
* экспертная оценка.

---

### 7. Галлюцинаторная устойчивость (Hallucination Resistance Score, HRS)

**Описание:**
Отсутствие:

* вымышленных норм,
* несуществующих законов,
* ложных судебных решений.

**Метрика:**

* доля ответов без вымышленных источников (%);
* бинарная классификация (галлюцинация / нет).

---

### 8. Процедурная корректность агента (Agent Reasoning Quality, ARQ)

**Описание:**
Качество агентной логики принятия решений.

**Оценивается:**

* корректность запуска retrieval;
* оправданность рекурсивных шагов;
* своевременность завершения поиска.

**Методы:**

* трассировка графа LangGraph;
* лог-анализ переходов состояний.

---

## Интегральная метрика качества

Формируется агрегированная оценка:

[
Q = \alpha LCS + \beta SGS + \gamma NVS + \delta LCV + \epsilon SCS + \zeta CRS + \eta HRS + \theta ARQ
]

где коэффициенты задаются эмпирически в зависимости от приоритетов задачи
(например, юридическая корректность и отсутствие галлюцинаций имеют больший вес).

---

## Итоговая формулировка

Качество юридических ответов оценивается не как качество генерации текста, а как **качество
правового решения**, включающего:

* корректность,
* источниковую обоснованность,
* актуальность,
* полноту анализа,
* объяснимость,
* агентную логику принятия решений.

Таким образом, система рассматривается не как чат-бот, а как **интеллектуальный правовой
аналитический инструмент**.

Ниже приведена **табличная форма критериев оценки качества юридических ответов**, оформленная в
виде, пригодном для **методического раздела ВКР** (без лишней публицистики, с формальными
формулировками).

---

## Критерии оценки качества юридических ответов LLM-ассистента

| № | Критерий                        | Обозначение                          | Описание                                                                            | Метод оценки                             | Шкала                                                                                   |
|---|---------------------------------|--------------------------------------|-------------------------------------------------------------------------------------|------------------------------------------|-----------------------------------------------------------------------------------------|
| 1 | Юридическая корректность        | LCS (Legal Correctness Score)        | Соответствие ответа действующему законодательству и правоприменительной практике    | Экспертная оценка юриста                 | 0 — некорректно<br>1 — частично корректно<br>2 — корректно                              |
| 2 | Обоснованность по источникам    | SGS (Source Grounding Score)         | Наличие и идентифицируемость источников права (НПА, разъяснения, судебная практика) | Подсчёт источников + экспертная проверка | 0 — источников нет<br>1 — источники указаны частично<br>2 — источники указаны корректно |
| 3 | Актуальность правовых норм      | NVS (Norm Validity Score)            | Соответствие указанных норм действующей редакции                                    | Экспертная проверка                      | 0 — утратили силу<br>1 — устаревшая редакция<br>2 — актуальная редакция                 |
| 4 | Полнота правового анализа       | LCV (Legal Coverage Score)           | Охват всех юридически значимых аспектов запроса                                     | Сравнение с эталонным разбором           | 0 — низкая полнота<br>1 — частичная полнота<br>2 — полная                               |
| 5 | Структурная корректность        | SCS (Structural Compliance Score)    | Логичность, структурированность и аргументированность ответа                        | Чек-лист                                 | 0 — структура отсутствует<br>1 — частично<br>2 — полностью                              |
| 6 | Контекстуальная релевантность   | CRS (Contextual Relevance Score)     | Соответствие ответа исходному запросу без избыточной генерализации                  | Экспертная оценка / LLM-as-a-Judge       | 0 — нерелевантно<br>1 — частично<br>2 — релевантно                                      |
| 7 | Устойчивость к галлюцинациям    | HRS (Hallucination Resistance Score) | Отсутствие вымышленных норм, актов и судебных решений                               | Экспертная проверка                      | 0 — есть галлюцинации<br>1 — нет галлюцинаций                                           |
| 8 | Процедурная корректность агента | ARQ (Agent Reasoning Quality)        | Корректность агентных решений: запуск retrieval, рекурсия, остановка                | Анализ логов LangGraph                   | 0 — ошибки логики<br>1 — корректно                                                      |

---

## Интегральная оценка качества

Для итоговой оценки качества ответа используется взвешенная сумма:

[
Q = \sum_{i=1}^{n} w_i \cdot S_i
]

где:

* ( S_i ) — нормализованное значение i-го критерия,
* ( w_i ) — вес критерия (например, LCS и HRS имеют максимальный вес).

> Предложенная система оценки ориентирована на анализ **юридической состоятельности ответа**, а не
> только на качество текстовой генерации. Это позволяет рассматривать LLM-ассистента как инструмент
> правового анализа, а не как диалоговую систему общего назначения.

# Реализация системы

## Типы запросов

### Категория «НПА»

(Запросы о нормах, содержащихся в официальных текстах законов и подзаконных актов)

1. Какая ставка НДС применяется к услугам по образованию?
2. Каков порядок увольнения сотрудника по инициативе работодателя?
3. Какие требования пожарной безопасности предъявляются к офисным зданиям?
4. Какие документы необходимы для регистрации права собственности на квартиру?
5. Каков срок давности по взысканию задолженности по коммунальным платежам?
6. Какие условия должны быть соблюдены для получения налогового вычета на лечение?

### Категория «Судебное»

(Запросы о практике применения норм судами, толковании законов в конкретных спорах)

1. Как суды толкуют понятие «существенное нарушение условий договора»?
2. Как арбитражные суды разрешают споры о взыскании неустойки за просрочку поставки?
3. Какая практика Верховного Суда по возмещению морального вреда при увольнении?
4. Какие аргументы принимают суды при оспаривании кадастровой стоимости земли?
5. Как судебная практика рассматривает споры о разделе совместно нажитого имущества?
6. Какова позиция судов по взысканию убытков с директора компании?

## Результаты работы

Разработано следующе программное обеспечение для реализации агента - консультанта:

- `prototype/PravoMentor` - прототип агента, реализованный в виде монолита для подтверждения концепции.
- `pravo_app` - полноценный модуль юридического агента.
- `legal_request.py` - импорт данных запросов, пакетный прогон, формирование итогового документа.
- `Expert Quality Assessment/import_metrics.py` - скрипты оценки качества ответов
- `langgraph.json` -  конфигурация для запуска в LangGraph Studio

1. Для оценки качества агента разработаны 135 запросов в 9 категориях из раздела права взаимодействия жильцов и управляющей компании ЖКХ - [LLM-агент юридического ассистента. Запросы для тестирования .docx](legal%20requests/LLM-%D0%B0%D0%B3%D0%B5%D0%BD%D1%82%20%D1%8E%D1%80%D0%B8%D0%B4%D0%B8%D1%87%D0%B5%D1%81%D0%BA%D0%BE%D0%B3%D0%BE%20%D0%B0%D1%81%D1%81%D0%B8%D1%81%D1%82%D0%B5%D0%BD%D1%82%D0%B0.%20%D0%97%D0%B0%D0%BF%D1%80%D0%BE%D1%81%D1%8B%20%D0%B4%D0%BB%D1%8F%20%D1%82%D0%B5%D1%81%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F%20.docx)
2. После прогона в пакетном режиме получены следующие структурированные ответы - [LLM-агент юридического ассистента. Тестирование на реальных запросах.docx](legal%20requests/LLM-%D0%B0%D0%B3%D0%B5%D0%BD%D1%82%20%D1%8E%D1%80%D0%B8%D0%B4%D0%B8%D1%87%D0%B5%D1%81%D0%BA%D0%BE%D0%B3%D0%BE%20%D0%B0%D1%81%D1%81%D0%B8%D1%81%D1%82%D0%B5%D0%BD%D1%82%D0%B0.%20%D0%A2%D0%B5%D1%81%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5%20%D0%BD%D0%B0%20%D1%80%D0%B5%D0%B0%D0%BB%D1%8C%D0%BD%D1%8B%D1%85%20%D0%B7%D0%B0%D0%BF%D1%80%D0%BE%D1%81%D0%B0%D1%85.docx)
3. Приведен пример полной экспертной оценки первых трех первых запросов - [Анализ качества ответа с обоснованием запросов 1-3.md](Expert%20Quality%20Assessment/%D0%90%D0%BD%D0%B0%D0%BB%D0%B8%D0%B7%20%D0%BA%D0%B0%D1%87%D0%B5%D1%81%D1%82%D0%B2%D0%B0%20%D0%BE%D1%82%D0%B2%D0%B5%D1%82%D0%B0%20%D1%81%20%D0%BE%D0%B1%D0%BE%D1%81%D0%BD%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5%D0%BC%20%D0%B7%D0%B0%D0%BF%D1%80%D0%BE%D1%81%D0%BE%D0%B2%201-3.md)
4. Таблица экспертной оценки на все 135 запросов - [Таблица экспертной оценки качества ответов.md](Expert%20Quality%20Assessment/%D0%A2%D0%B0%D0%B1%D0%BB%D0%B8%D1%86%D0%B0%20%D1%8D%D0%BA%D1%81%D0%BF%D0%B5%D1%80%D1%82%D0%BD%D0%BE%D0%B9%20%D0%BE%D1%86%D0%B5%D0%BD%D0%BA%D0%B8%20%D0%BA%D0%B0%D1%87%D0%B5%D1%81%D1%82%D0%B2%D0%B0%20%D0%BE%D1%82%D0%B2%D0%B5%D1%82%D0%BE%D0%B2.md)
5. Для пдсчета выбраны следующие веса метрик - [Веса метрик.md](Expert%20Quality%20Assessment/%D0%92%D0%B5%D1%81%D0%B0%20%D0%BC%D0%B5%D1%82%D1%80%D0%B8%D0%BA.md)

**Достигнутое качество - Average Q: 0.7019**

# Источники и литература

1. [Общее обсуждение задачи](https://chatgpt.com/share/6974e0c9-3e98-8000-aae6-cacdd761294b)
2. [The Self-Correcting RAG: Implementing Agentic and Recursive Retrieval Loops](https://minusx.ai/blog/decoding-claude-code/)
3. **Душкин Р. В.** Метакогнитивная промпт-инженерия. — М.: ДМК Пресс, 2025. — 238 с. ISBN
   978-5-93700-425-3.
4. **Берриман Дж., Циглер А.** Промт-инжиниринг для LLM. Искусство построения приложений на основе
   больших языковых моделей / Пер. с англ. Д. Брайт; Науч. ред. А. Лашнёв. — Астана: Спринт Бук,
   2025. — 288 с. ISBN 978-601-12-3473-3.
5. **Хьюен Ч.** AI-инженерия. Построение приложений с использованием базовых моделей. — Астана:
   Спринт Бук, 2025. — 560 с. ISBN 978-601-12-4595-1.
6. **Berryman J., Ziegler A.** Prompt Engineering for LLMs. — Sebastopol, CA: O’Reilly Media, Inc.,
   2025. — 1st ed.
7. **Ротман Д.** RAG и генеративный ИИ. Создаем собственные RAG-пайплайны с помощью LlamaIndex, Deep
   Lake и Pinecone. — Астана: Спринт Бук, 2025. — 320 с. ISBN 978-601-12-3149-7.
8. **Цзяншу Ю., Чжаохуа В., Лици И., Цзиган Л.** Агенты искусственного интеллекта: Руководство по
   разработке / пер. с кит. И. Л. Люско. — М.: ДМК Пресс, 2025. — 502 с. ISBN 978-5-93700-410-9.
9. **Avila R. D., Ahmad I.** Architecting AI Software Systems: Crafting robust and scalable AI
   systems for modern software development. — Birmingham, UK: Packt Publishing Ltd., 2025. — 1st ed.
   ISBN 978-1-80461-597-3.
10. [Курс Agentic AI](https://learn.deeplearning.ai/courses/agentic-ai/lesson/pu5xbv/welcome!)
11. [Пример реализации demo_recursive_rag_langgraph](https://github.com/mlnavigator/langgraph_demo/tree/main)

